name: Run Kotlin Crawler Daily

# è§¦å‘æ¡ä»¶ï¼šæ¯å¤© UTC æ—¶é—´ 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
# ä¹Ÿå¯æ‰‹åŠ¨è§¦å‘
on:
  schedule:
    - cron: '0 0 * * *'  # UTC æ—¶é—´æ¯å¤© 00:00
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  run-crawler:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # å¿…é¡»æä¾› token æ‰èƒ½åç»­æäº¤å›ä»“åº“
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. ä¿®å¤ gradlew å¯æ‰§è¡Œæƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼ï¼‰
      - name: Make gradlew executable
        run: |
          chmod +x ./gradlew || echo "gradlew not found or already executable"

      # 3. è®¾ç½® JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'  # ç¼“å­˜ Gradle ä¾èµ–ï¼ŒåŠ å¿«æ„å»º

      # 4. æ„å»ºé¡¹ç›®
      - name: Build with Gradle
        run: ./gradlew build
        # å¦‚æœä½ åªæƒ³è¿è¡Œè€Œä¸æ„å»ºï¼Œå¯ä»¥ç”¨: ./gradlew assemble

      # 5. è¿è¡Œçˆ¬è™«ï¼ˆå‡è®¾ä½ çš„ main class ä¼šè¢« gradle æ­£ç¡®è¯†åˆ«ï¼‰
      - name: Run crawler
        run: ./gradlew run

      # 6. æäº¤ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶ï¼ˆä¾‹å¦‚ datas/*.jsonï¼‰
      - name: Commit data to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"

          # åªæ·»åŠ  datas/ ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶ï¼ˆé¿å…æäº¤ build/ ç­‰ï¼‰
          git add datas/*.gz 2>/dev/null || echo "No new data files to add"

          # å¦‚æœæœ‰å˜æ›´ï¼Œåˆ™æäº¤
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Update crawler data: $(date '+%Y-%m-%d %H:%M:%S')"
          fi

          # æ¨é€åˆ° master åˆ†æ”¯
          git push origin HEAD:dataset

        # æ³¨æ„ï¼šGITHUB_TOKEN é»˜è®¤æœ‰å†™æƒé™ï¼ˆå½“åœ¨ workflow ä¸­è§¦å‘æ—¶ï¼‰